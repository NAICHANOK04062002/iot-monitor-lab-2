<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab IoT Receiver - Private Project</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Firebase ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ---
        const firebaseConfig = {
            apiKey: "AIzaSyCyM5EA_WYq0aPl30Fui3HWdlSzC0VYVi4",
            authDomain: "iot-project-2-728f2.firebaseapp.com",
            projectId: "iot-project-2-728f2",
            storageBucket: "iot-project-2-728f2.firebasestorage.app",
            messagingSenderId: "439399151074",
            appId: "1:439399151074:web:ccca965cc2aa3f5379b5bb",
            measurementId: "G-SJNDKFR63C"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // App ID ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏¢‡∏Å‡∏ä‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏•‡∏≠‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÉ‡∏ô ESP32)
        const currentAppId = "my-private-lab-001"; 

        window.state = {
            data: JSON.parse(localStorage.getItem('lab_data_final')) || {
                exp1: { scenario1: { 1: {}, 2: {}, 3: {} }, scenario2: { 1: {}, 2: {}, 3: {} } }
            },
            currentS1: 1,
            iotEnabled: false,
            unsubscribe: null,
            chart: null,
            selectedMetric: 'co2'
        };

        const timePoints = [10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 120, 130, 140, 150];
        const metrics = [
            { id: 'co2', label: 'CO2 (ppm)' },
            { id: 'dust', label: '‡∏ù‡∏∏‡πà‡∏ô (¬µg/m¬≥)' },
            { id: 'tempIn', label: '‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡πÉ‡∏ô' },
            { id: 'tempOut', label: '‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏ô‡∏≠‡∏Å' }
        ];

        window.toggleIoT = async () => {
            window.state.iotEnabled = !window.state.iotEnabled;
            const btn = document.getElementById('iot-btn');
            if (window.state.iotEnabled) {
                btn.className = "bg-emerald-500 text-white px-6 py-2 rounded-full font-bold animate-pulse shadow-lg";
                btn.innerHTML = "üì° ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Cloud...";
                await signInAnonymously(auth);
                // FIXED PATH: 6 segments for document
                const docRef = doc(db, 'artifacts', currentAppId, 'public', 'data', 'esp32_readings', 'latest');
                window.state.unsubscribe = onSnapshot(docRef, (snap) => {
                    if (snap.exists()) {
                        const incoming = snap.data();
                        if (incoming.exp1) {
                            // Merge IoT data into local
                            Object.keys(incoming.exp1).forEach(s => {
                                Object.keys(incoming.exp1[s]).forEach(t => {
                                    Object.keys(incoming.exp1[s][t]).forEach(time => {
                                        if(!window.state.data.exp1[s][t][time]) window.state.data.exp1[s][t][time] = {};
                                        window.state.data.exp1[s][t][time] = {...window.state.data.exp1[s][t][time], ...incoming.exp1[s][t][time]};
                                    });
                                });
                            });
                            saveAndRender();
                        }
                    }
                });
            } else {
                btn.className = "bg-slate-200 text-slate-500 px-6 py-2 rounded-full font-bold";
                btn.innerHTML = "üîå ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö IoT";
                if(window.state.unsubscribe) window.state.unsubscribe();
            }
        };

        const saveAndRender = () => {
            localStorage.setItem('lab_data_final', JSON.stringify(window.state.data));
            window.renderUI();
        };

        window.updateManual = (s, t, time, m, val) => {
            if (!window.state.data.exp1['scenario'+s][t][time]) window.state.data.exp1['scenario'+s][t][time] = {};
            window.state.data.exp1['scenario'+s][t][time][m] = val === '' ? null : parseFloat(val);
            saveAndRender();
        };

        window.renderUI = () => {
            const container = document.getElementById('tables-container');
            const s = window.state.currentS1;
            container.innerHTML = '';
            
            [1, 2, 3, 'avg'].forEach(t => {
                const isAvg = t === 'avg';
                let html = `<div class="bg-white rounded-2xl shadow-md border-t-4 ${isAvg ? 'border-blue-600' : 'border-slate-300'} p-4 mb-6 hide-for-graphs-only">
                    <h3 class="font-bold mb-4 uppercase text-sm ${isAvg ? 'text-blue-700' : 'text-slate-500'}">
                        ${isAvg ? '‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏•‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ' + t}
                    </h3>
                    <div class="overflow-x-auto"><table class="w-full text-[11px] border-collapse">
                        <thead><tr class="bg-slate-50"><th class="p-2 border">‡∏ô‡∏≤‡∏ó‡∏µ</th>${metrics.map(m=>`<th class="p-2 border">${m.label}</th>`).join('')}</tr></thead><tbody>`;
                
                timePoints.forEach(tp => {
                    html += `<tr><td class="p-2 border text-center font-bold bg-slate-50">${tp}</td>`;
                    metrics.forEach(m => {
                        let val = isAvg ? calculateAvg(s, tp, m.id) : (window.state.data.exp1['scenario'+s][t][tp]?.[m.id] || '');
                        html += `<td class="p-0 border"><input type="number" value="${val}" ${isAvg?'disabled':''} onchange="updateManual(${s},${t},${tp},'${m.id}',this.value)" class="w-full p-2 text-center border-none outline-none ${isAvg?'bg-blue-50 font-bold text-blue-600':''}"></td>`;
                    });
                    html += `</tr>`;
                });
                container.innerHTML += html + `</tbody></table></div></div>`;
            });
            renderChart();
        };

        const calculateAvg = (s, time, m) => {
            let sum = 0, count = 0;
            [1, 2, 3].forEach(t => {
                const v = window.state.data.exp1['scenario'+s][t][time]?.[m];
                if(v != null && !isNaN(v)) { sum += v; count++; }
            });
            return count > 0 ? (sum / count).toFixed(1) : '-';
        };

        const renderChart = () => {
            const ctx = document.getElementById('mainChart');
            const m = window.state.selectedMetric;
            const labels = timePoints.map(t => t + 'm');
            const datasets = [1,2,3].map(t => ({
                label: '‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ' + t,
                data: timePoints.map(tp => window.state.data.exp1['scenario'+window.state.currentS1][t][tp]?.[m] || null),
                borderColor: t===1?'#3b82f6':(t===2?'#10b981':'#f59e0b'), tension: 0.3, fill: false, pointRadius: 4
            }));
            // Add Average Line
            datasets.push({
                label: '‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢',
                data: timePoints.map(tp => {
                    const a = calculateAvg(window.state.currentS1, tp, m);
                    return a === '-' ? null : parseFloat(a);
                }),
                borderColor: '#ef4444', borderDash: [5, 5], borderWidth: 3, tension: 0.3, pointRadius: 0, fill: false
            });

            if(window.state.chart) window.state.chart.destroy();
            window.state.chart = new Chart(ctx, { 
                type: 'line', 
                data: { labels, datasets }, 
                options: { 
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { title: { display: true, text: m.toUpperCase() } }, x: { title: { display: true, text: '‡∏ô‡∏≤‡∏ó‡∏µ' } } }
                } 
            });
        };

        window.onload = () => { window.renderUI(); };
        window.switchS = (v) => { window.state.currentS1 = parseInt(v); window.renderUI(); };
        window.changeMetric = (id) => { window.state.selectedMetric = id; window.renderUI(); };
        
        window.exportReport = (type) => {
            const onlyGraphs = document.getElementById('check-only-graphs').checked;
            const element = document.getElementById('capture-area');
            if (onlyGraphs) element.classList.add('graphs-only-mode');
            
            setTimeout(() => {
                if(type === 'pdf') {
                    html2pdf().from(element).set({ margin: 10, filename: 'lab_report.pdf', html2canvas: { scale: 2 } }).save().then(() => {
                        element.classList.remove('graphs-only-mode');
                    });
                } else {
                    window.print();
                    element.classList.remove('graphs-only-mode');
                }
            }, 500);
        };
    </script>
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f1f5f9; }
        .header-gradient { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        .metric-btn { @apply px-3 py-1 text-xs rounded-full border bg-white transition-all; }
        .metric-btn.active { @apply bg-blue-600 text-white border-blue-600 font-bold shadow-md; }
        @media print { .no-print { display: none !important; } }
        .graphs-only-mode .hide-for-graphs-only { display: none !important; }
        .graphs-only-mode { background: white !important; }
    </style>
</head>
<body class="pb-20">
    <header class="header-gradient text-white p-6 shadow-xl no-print">
        <div class="max-w-5xl mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold flex items-center gap-2"><i class="fa-solid fa-microscope text-blue-400"></i> Lab IoT Pro Receiver</h1>
            <div class="flex gap-2">
                <button id="iot-btn" onclick="toggleIoT()" class="bg-slate-100 text-slate-600 px-5 py-2 rounded-full text-xs font-bold shadow-inner">üîå ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö IoT</button>
                <button onclick="document.getElementById('export-modal').classList.remove('hidden')" class="bg-blue-600 px-4 py-2 rounded-lg"><i class="fa-solid fa-download"></i></button>
            </div>
        </div>
    </header>

    <main class="max-w-5xl mx-auto p-4 mt-6">
        <div id="capture-area">
            <!-- Graph Card -->
            <div class="bg-white rounded-3xl shadow-xl p-6 mb-8 border border-slate-200">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-slate-700">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®</h3>
                    <div class="flex gap-1 no-print">
                        <button onclick="changeMetric('co2')" class="metric-btn active">CO2</button>
                        <button onclick="changeMetric('dust')" class="metric-btn">‡∏ù‡∏∏‡πà‡∏ô</button>
                    </div>
                </div>
                <div class="h-[400px] w-full"><canvas id="mainChart"></canvas></div>
            </div>

            <!-- Controls -->
            <div class="bg-white p-4 rounded-2xl shadow-sm border mb-6 no-print hide-for-graphs-only">
                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå</label>
                <select onchange="switchS(this.value)" class="w-full p-3 border rounded-xl bg-slate-50 font-bold outline-none">
                    <option value="1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå 1: ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°</option>
                    <option value="2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå 2: ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏ó‡∏≥‡∏Ç‡∏∂‡πâ‡∏ô</option>
                </select>
            </div>

            <!-- Tables -->
            <div id="tables-container"></div>
        </div>
    </main>

    <!-- Export Modal -->
    <div id="export-modal" class="fixed inset-0 bg-black/60 z-[100] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white p-8 rounded-3xl w-full max-w-sm shadow-2xl">
            <h3 class="font-bold text-lg mb-6">‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å</h3>
            <label class="flex items-center gap-3 p-4 border-2 border-blue-50 bg-blue-50/50 rounded-2xl mb-6 cursor-pointer">
                <input type="checkbox" id="check-only-graphs" class="w-5 h-5">
                <span class="font-bold text-blue-800">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</span>
            </label>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="exportReport('pdf')" class="bg-red-600 text-white py-3 rounded-xl font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å PDF</button>
                <button onclick="exportReport('print')" class="bg-slate-800 text-white py-3 rounded-xl font-bold">‡∏û‡∏¥‡∏°‡∏û‡πå</button>
                <button onclick="document.getElementById('export-modal').classList.add('hidden')" class="col-span-2 text-slate-400 text-center py-2">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </div>
    </div>
</body>
</html>